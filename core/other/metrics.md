# Метрики

1. Типы метрик
2. Структура метрик
3. Базовые индикаторы приложений

## Типы метрик

### Counter

**Counter** (счетчик) - это метрика, которая представляет собой счетчик, который увеличивается на 1 каждый раз, когда
происходит определенное событие или действие. Счетчики широко используются в мониторинге и анализе систем для
отслеживания количества событий, происходящих в системе, таких как количество запросов к API, количество обращений к
базе данных или количество ошибок, которые произошли в системе. Счетчики обычно отслеживаются в реальном времени и могут
быть очень полезны для быстрого обнаружения проблем в системе. Они могут быть использованы для мониторинга
производительности, доступности и надежности системы.

Примеры метрик **Counter**:

* Количество запросов к серверу
* Количество сообщений, отправленных в очередь
* Количество обращений к базе данных
* Количество ошибок, возникших в системе
* Количество запросов на скачивание файлов

Счетчики могут также быть использованы для расчета различных показателей, таких как среднее количество запросов в
секунду или количество запросов, выполненных в определенное время. Они могут быть интегрированы с другими системами
мониторинга, такими как Grafana или Prometheus, для создания дашбордов и анализа данных.

### Histogram

**Histogram** (гистограмма) - это метрика, которая измеряет распределение значений определенной переменной.

Гистограммы широко используются в мониторинге и анализе систем для анализа распределения времени ответа API, размера
файлов, которые передаются между компьютерами или размера запросов, поступающих на сервер.

Гистограммы представляют данные в виде интервалов значений, в которых находятся события или действия. Диапазон значений
разбивается на определенное число интервалов, и количество событий, которые попали в каждый интервал, записывается в
виде числа или процента. Это позволяет анализировать распределение значений и находить аномальные данные.

Примеры метрик **Histogram**:

* Распределение времени ответа **API** по интервалам (0-50 мс, 50-100 мс, 100-200 мс, и т.д.)
* Размер файлов, переданных между компьютерами, по интервалам (0-1 МБ, 1-10 МБ, 10-100 МБ, и т.д.)
* Количество запросов на сервер, выполненных в определенное время, по интервалам (0-100 запросов, 100-500 запросов,
  500-1000 запросов, и т.д.)

Гистограммы могут быть использованы для анализа различных аспектов системы и помочь быстро выявить проблемы, такие как
длительное время ответа или большой объем данных, передаваемых между компьютерами. Они также могут быть интегрированы с
другими системами мониторинга, такими как Grafana или Prometheus, для создания дашбордов и анализа данных

### Gauge

**Gauge** (шкала) - это метрика, которая измеряет текущее значение переменной или состояние системы.

Она представляет собой точечную метрику, которая может изменяться как вверх, так и вниз в течение времени. Gauge широко
используется в мониторинге и анализе систем для отслеживания текущего состояния системы и определения проблем в реальном
времени.

Примеры метрик **Gauge**:

* Текущая загрузка **CPU**
* Количество активных соединений с базой данных
* Количество пользователей, вошедших в систему в данный момент времени
* Количество свободной оперативной памяти

Шкала может изменяться в любом направлении в зависимости от текущего состояния системы. Он может увеличиваться при
увеличении нагрузки на систему и уменьшаться, когда нагрузка снижается. **Gauge** может также использоваться для
определения количества доступных ресурсов в системе и для управления нагрузкой на систему. Шкалы могут быть
интегрированы с другими системами мониторинга, такими как **Grafana** или **Prometheus**, для создания дашбордов и
анализа данных. Они могут также использоваться для расчета различных показателей, таких как среднее значение переменной
или изменение переменной за определенный период времени.

### Summary

**Summary** (сводка результатов) - это метрика, которая измеряет распределение значений переменной и предоставляет
краткую сводку этого распределения. Summary метрики представляют данные в виде нескольких счетчиков, включая сумму всех
значений, количество значений и процентиль, представляющий, какое значение является порогом для указанного процента
значений.

**Summary** широко используется в мониторинге и анализе систем для анализа распределения значений переменной и
нахождения аномалий. Он также может использоваться для определения медианы и других процентилей, чтобы понять, какие
значения являются наиболее типичными для системы.

Примеры метрик **Summary**:

* Распределение времени ответа **API**
* Количество пользователей, зарегистрированных в системе
* Распределение размера файлов, переданных между компьютерами

**Summary** метрики могут использоваться для анализа различных аспектов системы и помочь быстро выявить проблемы, такие
как длительное время ответа или большой объем данных, передаваемых между компьютерами.

## Структура метрик

Структура метрик обычно состоит из имени метрики и набора лейблов (также называемых метками или тегами), которые
позволяют добавлять дополнительную информацию к метрике. Лейблы являются именами или значениями, которые позволяют
идентифицировать и отличать метрики друг от друга. Лейблы могут быть использованы для маркировки метрик в зависимости от
контекста, в котором они используются, или для добавления метаданных к метрикам, таких как имя хоста, номер порта, имя
приложения и т.д.

Структура имени метрики и лейблов может варьироваться в зависимости от используемой системы мониторинга, но обычно она
имеет следующий вид:

```php
<имя_метрики>{<метка1>=<значение1>, <метка2>=<значение2>, ..., <меткаN>=<значениеN>}
```

Например, для метрики, измеряющей количество запросов к серверу, мы можем использовать следующую структуру:

```sql
http_requests_total
{method="GET", endpoint="/api/users", status_code="200"}
В этом примере http_requests_total - имя метрики, а {method="GET", endpoint="/api/users", status_code="200"} - набор лейблов, описывающих контекст, в котором собираются данные о количестве запросов. Лейблы могут быть использованы для фильтрации и агрегации метрик, что позволяет анализировать данные в более удобном формате.
```

Структура метрик с лейблами позволяет создавать более гибкие и мощные системы мониторинга, позволяющие анализировать
данные с точностью до конкретного хоста, приложения, контекста запроса и т.д.

## Базовые индикаторы приложений

Базовые индикаторы приложений — это метрики и стандарты для оценки производительности, доступности и надежности
приложений. Существует несколько различных наборов индикаторов, которые используются в индустрии, включая 4 Golden
Signals, RED и USE.

### 4 Golden Signals

**4 Golden Signals** (четыре золотые метрики) - это набор метрик, разработанный **Google** для оценки производительности
и доступности приложений.

Он включает в себя следующие метрики:

* Latency (Задержка) - время, необходимое для обработки запроса от пользователя
* Traffic (Трафик) - количество запросов, обрабатываемых приложением
* Errors (Ошибки) - количество ошибок, происходящих в приложении
* Saturation (Насыщенность) - степень загрузки ресурсов приложения (например, CPU, память, сетевой трафик)

### RED

**RED** (Rate, Errors, Duration) - это набор метрик, разработанный **Uber** для оценки производительности и доступности
приложений.

Он включает в себя следующие метрики:

* Rate (Скорость) - количество запросов, поступающих в приложение за единицу времени
* Errors (Ошибки) - количество ошибок, происходящих в приложении за единицу времени
* Duration (Продолжительность) - время, необходимое для обработки запроса от пользователя

### USE

**USE** (Utilization, Saturation, Errors) - это набор метрик, разработанный **Brendan Gregg** для оценки
производительности и доступности системы.

Он включает в себя следующие метрики:

* Utilization (Использование) - процент использования ресурса (например, CPU, память, дисковое пространство)
* Saturation (Насыщенность) - степень загрузки ресурса (например, количество ожидающих запросов в очереди)
* Errors (Ошибки) - количество ошибок, происходящих в системе

Наборы метрик **4 Golden Signals**, **RED** и **USE** используются для оценки производительности и доступности
приложений и могут помочь быстро выявлять проблемы, такие как длительное время ответа, большой объем трафика, ошибки и
насыщение ресурсов. Каждый из наборов метрик может быть настроен под конкретное приложение и контекст использования.

## Примеры архитектуры мониторинга метрик:

1. **Micrometer**: это библиотека, которая предоставляет универсальный **API** для создания метрик для различных систем
   мониторинга, таких как **Prometheus**, **Datadog** и **Graphite**.
2. **Spring Boot Actuator**: это инструмент, который предоставляет готовые метрики для приложений на Spring. Он включает
   в себя метрики для HTTP-запросов, использования памяти и других показателей.
3. **Prometheus**: это система мониторинга, которая может собирать метрики от приложений на **Java Spring** с помощью
   библиотеки **Micrometer**.
4. **Grafana**: это инструмент для визуализации метрик, который может работать с различными системами мониторинга,
   включая
   **Prometheus**.
5. **ELK Stack**: это набор инструментов для сбора, хранения и анализа логов приложений. Он также может использоваться
   для создания метрик на основе логов

### Пример реализации мониторинга с помощью Prometheus -> Grafana:

Добавление зависимостей в **pom.xml**:

```xml

<dependency>
  <groupId>io.micrometer</groupId>
  <artifactId>micrometer-registry-prometheus</artifactId>
  <version>1.7.0</version>
</dependency>
<dependency>
<groupId>org.springframework.boot</groupId>
<artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

Настройка метрик в **application.properties**:

```yaml
# настройки Actuator
management.endpoints.web.exposure.include=*
management.metrics.tags.application=${spring.application.name}

  # настройки Micrometer и Prometheus
management.metrics.export.prometheus.enabled=true
management.metrics.export.prometheus.path=/metrics
```

Создание контроллера для тестирования:

```java

@RestController
@RequestMapping("/api/test")
public class TestController {

    private final Counter testCounter = Metrics.counter("test_counter");

    @GetMapping
    public String test() {
        testCounter.increment();
        return "Test";
    }
}
```

Запуск приложения и проверка метрик в браузере:

```yaml
http://localhost:8080/actuator/prometheus
```

Настройка **Grafana** для визуализации метрик:

1. Добавить источник данных **Prometheus**
2. Создать дашборд и добавить график для метрики **test_counter**

Теперь при обращении к **/api/test** значение метрики **test_counter** будет увеличиваться, а в Grafana можно будет
увидеть график ее изменения в режиме реального времени.

Это простой пример мониторинга в **Java Spring** с использованием **Prometheus** и **Grafana**. Настройки и параметры
могут отличаться в зависимости от конкретных требований и задач.
